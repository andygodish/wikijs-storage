---
title: Kube-VIP Demo
description: Spinning up an RKE2 cluster to demonstrate basic usage of kube-vip.
published: true
date: 2022-07-20T21:48:14.208Z
tags: kubernetes, rke2, kubevip
editor: markdown
dateCreated: 2022-07-20T21:48:14.208Z
---

# Kube-vip

[Useful Information](https://gitlab.com/monachus/channel/-/tree/master/resources/2021-09-07-ha-rke2-kube-vip-rancher)

## Prerequisites

- Kubernetes cluster (RKE2 used in this demo)

## RKE2 Setup

I'm using a basic configuration in my homelab. Emphasis is places on presetting a tls-san entry for the future kube-vip ip (10.0.0.64) and fqdn. Example config: 

```
tls-san:
- server-1
- server-1.home.lan
- rke2-cluster.home.lan
- 10.0.0.64
```

With this in its proper place on your first server node, use the install script to kick things off. 

[Reference Docs](https://docs.rke2.io/install/quickstart/#1-run-the-installer)


### Convenient Node Variables

```
export VIP=10.0.0.64
export TAG=v0.4.4
export INTERFACE=ens18
export CONTAINER_RUNTIME_ENDPOINT=unix:///run/k3s/containerd/containerd.sock
export CONTAINERD_ADDRESS=/run/k3s/containerd/containerd.sock
export PATH=/var/lib/rancher/rke2/bin:$PATH
export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
alias k=kubectl
```

## Install Kube-vip

### Install RBAC Manifests

Placing yaml configuration as `/server/manfiests` will trigger rke2 to deploy as static resources.

```
curl -s https://kube-vip.io/manifests/rbac.yaml > /var/lib/rancher/rke2/server/manifests/kube-vip-rbac.yaml
```

### Pull Image

Uses the `$TAG` from the node variables above. 

```
crictl pull docker.io/plndr/kube-vip:$TAG
```

### Install Kube-vip

On k3s `ctr` is a link to `k3s` which has the namespace set by default, but on rke2 we
have to specify the namespace (namespace as in containerd namespace).

```
alias kube-vip="ctr --namespace k8s.io run --rm --net-host docker.io/plndr/kube-vip:$TAG vip /kube-vip"
```

#### Generate Manifest

This will use some of the convenience variables we previously set use them to output a manfiest that we can place in the same static directory used for the kube-vip RBAC above. 

```
kube-vip manifest daemonset \
    --arp \
    --interface $INTERFACE \
    --address $VIP \
    --controlplane \
    --leaderElection \
    --taint \
    --services \
    --inCluster | tee /var/lib/rancher/rke2/server/manifests/kube-vip.yaml
```

This should kick off the installation almost immediately. Verify a good installation by pinging the kube-vip IP that you set (10.0.0.64) previously.

## Join Additional Server Nodes using Kube-vip IP

Adjust the configuration files for your other nodes so that they are looking for the IP (or FQDN) of the newly configured kube-vip. You'll also need the token generated by the initial server node. 

```
token: <your-token>
server: https://10.0.0.64:9345
```

Once joined and presented in a ready status, you now have a working RKE2 cluster using kube-vip for 6443 traffic to the kube-apiserver. 




